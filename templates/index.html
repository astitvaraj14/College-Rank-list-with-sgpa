<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBIT Result Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --dark: #1e293b; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', sans-serif; min-height: 100vh; position: relative; }
        .card { border-radius: 20px; border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: fadeInUp 0.8s ease; background: white; }
        .btn-submit { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 12px; padding: 1rem; width: 100%; font-weight: 700; transition: all 0.3s ease; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-box { padding: 1.5rem; border-radius: 20px; color: white; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .bg-sgpa { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-marks { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-rank { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-fail { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .stat-value { font-size: 2.5rem; font-weight: 800; line-height: 1; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: rgba(255,255,255,0.1); }
        .rank-1 { background: linear-gradient(135deg, #fef3c7, #fde68a) !important; color: #78350f; font-weight: bold; }
        .rank-2 { background: linear-gradient(135deg, #f3f4f6, #e5e7eb) !important; color: #374151; font-weight: bold; }
        .rank-3 { background: linear-gradient(135deg, #fed7aa, #fdba74) !important; color: #9a3412; font-weight: bold; }
        #student-name { color: var(--dark); font-weight: 700; font-size: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: #f0f4ff; border-radius: 15px; border-left: 5px solid var(--primary); }
        .credit-footer { position: fixed; bottom: 10px; right: 15px; font-size: 0.85rem; color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; backdrop-filter: blur(5px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="text-center mb-5 text-white">
        <h1 class="fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);"><i class="fas fa-graduation-cap"></i> DBIT Result Portal</h1>
        <p class="fs-5 opacity-75">Check Results & Leaderboard - 1DB23CS & 1DB24CS Only</p>
    </div>

    <ul class="nav nav-pills justify-content-center mb-5" id="pills-tab">
        <li class="nav-item">
            <button class="nav-link active bg-white text-primary me-2 fw-bold" data-bs-toggle="pill" data-bs-target="#pills-check">
                <i class="fas fa-search"></i> Check Result
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link bg-white text-primary me-2 fw-bold" data-bs-toggle="pill" data-bs-target="#pills-leaderboard" onclick="fetchLeaderboard()">
                <i class="fas fa-trophy"></i> Leaderboard
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link bg-white text-danger fw-bold" data-bs-toggle="pill" data-bs-target="#pills-failures">
                <i class="fas fa-chart-pie"></i> Subject Analysis
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-check">
            <div class="row justify-content-center">
                <div class="col-md-5 mb-4">
                    <div class="card p-4">
                        <div class="text-center mb-3 p-3 bg-light rounded border">
                            <img id="captcha-img" src="" class="img-fluid rounded mb-2" style="min-height: 60px;">
                            <br>
                            <a href="#" onclick="loadCaptcha(); return false;" class="text-decoration-none fw-bold">
                                <i class="fas fa-sync-alt"></i> Reload
                            </a>
                        </div>
                        <form id="resultForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">USN</label>
                                <input type="text" name="usn" id="usn-input" class="form-control" placeholder="1DB23CS..." required maxlength="10">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Captcha</label>
                                <input type="text" name="captcha" class="form-control" placeholder="Enter code" required autocomplete="off">
                            </div>
                            <button type="submit" class="btn-submit">GET RESULT</button>
                        </form>
                        <div id="status-msg" class="mt-3 text-center fw-bold"></div>
                    </div>
                </div>

                <div class="col-md-7" id="result-section" style="display:none;">
                    <div class="card p-4">
                        <div id="student-name"></div>
                        <div class="stats-container">
                            <div class="stat-box bg-sgpa">
                                <div>SGPA</div>
                                <div class="stat-value" id="sgpa-display">0.00</div>
                                <div id="perc-display" class="fs-6 opacity-75">0.00%</div>
                            </div>
                            <div class="stat-box bg-marks">
                                <div>Marks</div>
                                <div class="stat-value" id="total-marks-display">0</div>
                            </div>
                            <div class="stat-box bg-rank">
                                <div>Rank</div>
                                <div class="stat-value" id="rank-display">#0</div>
                            </div>
                        </div>
                        <table class="table table-hover">
                            <thead class="table-light"><tr><th>Code</th><th>Subject</th><th>Marks</th><th>Status</th></tr></thead>
                            <tbody id="marks-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-leaderboard">
            <div class="card p-4">
                <h3 class="text-center mb-4 text-warning"><i class="fas fa-crown"></i> Top Performers</h3>
                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" onclick="toggleSort('rank')">Rank <span id="icon-rank"></span></th>
                                <th>USN</th>
                                <th>Name</th>
                                <th class="sortable" onclick="toggleSort('total_marks')">Marks <span id="icon-total_marks">‚ñº</span></th>
                                <th class="sortable" onclick="toggleSort('sgpa')">SGPA <span id="icon-sgpa"></span></th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-failures">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card p-4">
                        <h3 class="text-center mb-4 text-danger"><i class="fas fa-user-times"></i> Subject Analysis</h3>
                        
                        <div class="input-group mb-4">
                            <select id="subject-select" class="form-select form-select-lg">
                                <option value="" selected disabled>Select Subject to Analyze</option>
                                <option value="BCS501">BCS501 - Software Engineering</option>
                                <option value="BCS502">BCS502 - Computer Networks</option>
                                <option value="BCS503">BCS503 - Theory of Computation</option>
                                <option value="BCSL504">BCSL504 - Web Lab</option>
                                <option value="BCS515">BCS515 - Unix Shell</option>
                                <option value="BCS586">BCS586 - Mini Project</option>
                                <option value="BRMK557">BRMK557 - Research Methodology</option>
                                <option value="BESK508">BESK508 - Social Connect</option>
                            </select>
                            <button class="btn btn-danger px-4" onclick="fetchFailures()">Check</button>
                        </div>

                        <div id="failure-stats" class="text-center mb-4" style="display:none;">
                            <div class="stat-box bg-fail d-inline-block px-5">
                                <div>Total Failed Students</div>
                                <div class="stat-value" id="fail-count">0</div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover text-center align-middle border">
                                <thead class="table-danger">
                                    <tr><th>USN</th><th>Name</th><th>Marks Obtained</th><th>Result</th></tr>
                                </thead>
                                <tbody id="failures-body">
                                    <tr><td colspan="4" class="text-muted py-4">Select a subject to view failure list.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="credit-footer">Made with ‚ù§Ô∏è by Astitva & Arsalan</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. CAPTCHA & VALIDATION ---
    function loadCaptcha() { document.getElementById('captcha-img').src = "/get_captcha?" + new Date().getTime(); }
    window.onload = loadCaptcha;

    document.getElementById('usn-input').addEventListener('input', function(e) {
        let val = e.target.value.toUpperCase();
        e.target.value = val;
        if(val.length > 0) {
            e.target.style.borderColor = (val.startsWith('1DB23CS') || val.startsWith('1DB24CS')) ? '#10b981' : '#ef4444';
        }
    });

    // --- 2. FETCH RESULT ---
    document.getElementById('resultForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.querySelector('.btn-submit');
        const status = document.getElementById('status-msg');
        
        if (!this.usn.value.startsWith('1DB')) {
            status.innerHTML = '<span class="text-danger">Invalid USN! 1DB... only</span>'; return;
        }

        btn.disabled = true; btn.innerHTML = 'Fetching...';
        status.innerHTML = ''; document.getElementById('result-section').style.display = 'none';

        try {
            const res = await fetch('/fetch_result', { method: 'POST', body: new FormData(this) });
            const data = await res.json();

            if (data.status === 'success') {
                const s = data.data;
                document.getElementById('student-name').innerHTML = `<i class="fas fa-user-circle"></i> ${s.name}`;
                document.getElementById('sgpa-display').innerText = s.sgpa;
                document.getElementById('perc-display').innerText = s.percentage;
                document.getElementById('total-marks-display').innerText = s.total_marks;
                document.getElementById('rank-display').innerText = "#" + data.ranks.uni_rank;

                let rows = '';
                s.subjects.forEach(sub => {
                    const color = sub.result === 'P' ? 'text-success' : 'text-danger';
                    rows += `<tr><td class="fw-bold text-secondary">${sub.code}</td><td>${sub.name}</td><td class="fw-bold">${sub.total}</td><td class="${color} fw-bold">${sub.result}</td></tr>`;
                });
                document.getElementById('marks-body').innerHTML = rows;
                document.getElementById('result-section').style.display = 'block';
                document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
            } else {
                status.innerHTML = `<span class="text-danger">${data.message}</span>`;
                loadCaptcha();
            }
        } catch (err) { status.innerHTML = '<span class="text-danger">Server Error</span>'; }
        btn.disabled = false; btn.innerHTML = 'GET RESULT';
    });

    // --- 3. LEADERBOARD ---
    let sortField = 'total_marks'; let sortOrder = 'desc';
    function toggleSort(field) {
        sortOrder = (sortField === field && sortOrder === 'desc') ? 'asc' : 'desc';
        sortField = field;
        updateIcons(); fetchLeaderboard();
    }
    function updateIcons() {
        ['rank', 'total_marks', 'sgpa'].forEach(id => document.getElementById('icon-'+id).innerHTML = '');
        document.getElementById('icon-'+sortField).innerHTML = sortOrder === 'desc' ? '‚ñº' : '‚ñ≤';
    }
    async function fetchLeaderboard() {
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
            const res = await fetch(`/leaderboard?sort=${sortField}&order=${sortOrder}`);
            const json = await res.json();
            if (json.status === 'success') {
                let html = '';
                json.data.forEach(s => {
                    let cls = s.rank === 1 ? 'rank-1' : s.rank === 2 ? 'rank-2' : s.rank === 3 ? 'rank-3' : '';
                    let icon = s.rank === 1 ? 'ü•á' : s.rank === 2 ? 'ü•à' : s.rank === 3 ? 'ü•â' : '';
                    html += `<tr class="${cls}"><td>${icon} #${s.rank}</td><td>${s.usn}</td><td class="fw-bold">${s.name}</td><td class="text-primary fw-bold">${s.total_marks}</td><td class="text-success fw-bold">${s.sgpa}</td><td class="text-warning fw-bold">${s.percentage}</td></tr>`;
                });
                tbody.innerHTML = html;
            }
        } catch (err) { tbody.innerHTML = '<tr><td colspan="6" class="text-danger">Failed to load</td></tr>'; }
    }

    // --- 4. FAILURES ---
    async function fetchFailures() {
        const subject = document.getElementById('subject-select').value;
        const tbody = document.getElementById('failures-body');
        const statBox = document.getElementById('failure-stats');
        
        if (!subject) { alert("Please select a subject!"); return; }
        
        tbody.innerHTML = '<tr><td colspan="4">Searching database...</td></tr>';
        statBox.style.display = 'none';

        try {
            const res = await fetch(`/failures?subject=${subject}`);
            const json = await res.json();
            
            if (json.status === 'success') {
                document.getElementById('fail-count').innerText = json.count;
                statBox.style.display = 'block';
                
                if (json.count > 0) {
                    let html = '';
                    json.data.forEach(s => {
                        html += `<tr><td>${s.usn}</td><td>${s.name}</td><td class="fw-bold">${s.marks}</td><td class="text-danger fw-bold">${s.status}</td></tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-success fw-bold py-4"><i class="fas fa-check-circle"></i> No failures found in this subject! üéâ</td></tr>';
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-danger">${json.message}</td></tr>`;
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Error fetching data</td></tr>';
        }
    }
</script>
</body>
</html>